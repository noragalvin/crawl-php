angular.module('app', []).controller('main', ['$scope', '$http', function ($scope, $http) {
  $scope.count = 0;
  $scope.btn = function () {
    if ($scope.count == 1) return true; else return false;
  };
  $scope.options = [
    { name: 'Phim14', value: 'phim14' },
    { name: 'Phim mới', value: 'phimmoi' },
    { name: 'Phim bất hủ', value: 'phimbathu' },
    { name: 'BanhTV', value: 'banhtv' },
    { name: 'Bilutv', value: 'bilutv'}
  ];
  function merge(a) {
    var v = '';
    for (var i = 0; i < a.length-1; i++) v = v + a[i] + ', '; v = v + a[a.length-1];
    return v;
  }
  $scope.myshow = false;
  $scope.submit = function() {
    $scope.count++;
    $http.post('./api/' + $scope.site.value, {url: $scope.url}).then(e => e.data)
    .then(function (e) {
      $scope.image = e.image;
      $scope.name = e.name;
      $scope.status = e.status;
      $scope.director = e.director;
      $scope.actor = merge(e.actor);
      $scope.type = merge(e.type);
      $scope.nation = merge(e.nation);
      $scope.tags = merge(e.tags);
      $scope.info = e.info;
      var temp = "[stt/" + e.status +"]\n<!--more-->\n<div class=\"listtap\">\n";
      for (var i = 0; i < e.episode.length; i++) {
        temp += "\n\t[br]<b>" + e.episode[i].name + "</b>[br]\n";
        for (var j = 0; j < e.episode[i].list.length; j++) {
          var osign, csign, emb;
          if ($scope.site.value == 'phim14') {
            osign = 'p14'; csign = '/p14'; emb = e.episode[i].list[j].id;
          } else {
            osign = 'a'; csign = '/a'; emb = e.episode[i].list[j].link;
          }
          temp += "\t[" + osign + "=" + emb + "]" + e.episode[i].list[j].name + "[" + csign + "]\n";
        }
      }
      temp += "</div>\n<div class=\"thongtinphim\">\n\t<img src=\""+ e.image +"\" alt=\""+ e.name +"\"/><br/>\n\t" + e.info + "\n</div>";
      $scope.embedded = temp;
      $scope.count--;
      $scope.myshow = true;
    })
  }
}]);